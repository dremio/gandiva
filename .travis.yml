# Copyright (C) 2017-2018 Dremio Corporation
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Adapted from Apache Arrow
sudo: required
dist: trusty

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
      - llvm-toolchain-trusty-6.0
    packages:
      - gdb
      - ccache
      - clang-6.0
      - clang-format-6.0
      - clang-tidy-6.0
      - llvm-6.0-dev

cache:
  ccache: true

before_install:
  # Common pre-install steps for all builds
  - ulimit -c unlimited -S
  - |
      if [ $TRAVIS_OS_NAME == "linux" ]; then
        sudo bash -c "echo -e 'Acquire::Retries 10; Acquire::http::Timeout \"20\";' > /etc/apt/apt.conf.d/99-travis-retry"
        sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
        sudo apt-get update -qq
      fi

matrix:
  fast_finish: true
  allow_failures:
  include:
  - os: linux
    language: cpp
    compiler:
    - gcc
    env:
    - GANDIVA_TRAVIS_USE_TOOLCHAIN=1
    - GANDIVA_BUILD_WARNING_LEVEL=CHECKIN
    before_script:
    - ulimit -c unlimited -S
    - $TRAVIS_BUILD_DIR/ci/travis_before_script_cpp.sh
    # combining java and cpp build for now.
    # can separate them as needed later.
    - $TRAVIS_BUILD_DIR/ci/travis_before_script_java.sh
    script:
    - $TRAVIS_BUILD_DIR/ci/travis_script_cpp.sh && $TRAVIS_BUILD_DIR/ci/travis_script_java.sh

after_failure:
- COREFILE=$(find . -maxdepth 2 -name "core*" | head -n 1)
- if [[ -f "$COREFILE" ]]; then gdb -c "$COREFILE" example -ex "thread apply all bt" -ex "set pagination 0" -batch; fi

deploy:
  provider: gcs
  access_key_id: GOOGFNKJYF3SLAFIS7BYBNYS
  secret_access_key:
    secure: j4yRqvzTE0RXJYCR9tFLZGLJuUExpei50VmZAG5F5STzEt+lQSxDEki5j0ItBnv9GeOMsn0fUVndY7Vw1LiuiWaq3lTRdzsfoo0taXAzMFC32eyr9IFep6r02+08MgiwGkI5gKTkobUZv5Gj1tqTodRZWK/MOCYoDF3+Xa8T9T2z0FfDZiMBVAMc4OLX4BlCuw6Zyy4Y0aonwOeRfJWFiGRzbSTbFwGY5OAAPRbnJrnm7VcttTylWbpP4Y3EQCv8kcuYcBwsiUkj68NQTI27vB3oV81lWFWNKHvKLYd8UJtD6tS0pzG+awlDFbQAR4Y/0krFV3V8lkTQX7a7J0cGpd4ACK48hB/SmEJfq6tkCRJQXbyiQ8GWZvaVoWcKT0wiDRvY/3aYll2lPw14Iw01LQqbdW5vxt/Beh3hNnnuJJcYS/vhNiDZDrwg2sKRUO9BWh421iiAztlKCdvBIrQpBeEyxvouhOOBGpDZLU5O1QZaKr4zpGacd87TIWpI8oMmpbPzn1pqivzGXD7GPcb/HWBpsuNp10iIy/1Q+OqJi/OKTgoUx0Icl27BFFk/jowKghLofb5gKP5d4yLZ3A1+HUOvQEiR+kOolayHsdoKQlMfZIjDZ4oXO0kfQ+LXJpo+fp7HR70tTS1gxeHFn4VYGpm0kZeg965+B/ScwKx++EM=
  bucket: dremio-gandiva-data
  skip_cleanup: true
  detect_encoding: true
  local-dir: "/home/travis/build/dremio/gandiva/cpp-build"
